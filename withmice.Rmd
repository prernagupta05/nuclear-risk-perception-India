---
title: "models with mice"
output:
  pdf_document:
    toc: yes
    toc_depth: 2
    keep_tex: yes
  header-includes:
  - \usepackage{dcolumn}
  - \usepackage{array}
  - "\\usepackage{placeins}"
  keep_md: yes
---


```{r load packages, warning = FALSE, message = FALSE, echo=FALSE}
  knitr::opts_chunk$set(warning = FALSE, message = FALSE)

suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(readxl))
suppressPackageStartupMessages(library(dplyr))
suppressPackageStartupMessages(library(tidyr))
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(lavaan))
suppressPackageStartupMessages(library(tsibble))
suppressPackageStartupMessages(library(DT))
suppressPackageStartupMessages(library(knitr))
suppressPackageStartupMessages(library(psych)) 
suppressPackageStartupMessages(library(foreign))
suppressPackageStartupMessages(library(MASS))
suppressPackageStartupMessages(library(Hmisc))
suppressPackageStartupMessages(library(reshape2))

```

```{r setup, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)

moduletwo <- read_excel(here::here("thesis_surveydata/political_factors_complete.xlsx"))
module2 <- data.frame(moduletwo)
module2[module2 == "Rather not say/ Don't know"] <- "Rather not say/Don't know"



# loaded data set for module 2 eco -pol variables and removes the rows with question number and question text
```

```{r, eval =TRUE, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
#This chunk contains the coding schemes of various scales used in survey one: eco-political factors, kahan scale and acceptance scale
codedmodule2 <- module2 %>%
  
#remove row 1
  filter(!row_number() %in% c(1,2)) %>% 
  
# replace risky likert scale with numbers
  mutate_at(vars(starts_with("Risky")), funs(case_when(. =="Not at all risky" ~ 1, 
                                                       . =="Slightly risky" ~ 2, 
                                                       . =="Moderately risky" ~ 3, 
                                                       . =="Very risky" ~ 4, 
                                                       . =="Extremely risky" ~ 5))) %>%

# replace beneficial likert scale with numbers  
  mutate_at(vars(starts_with("Ben")), funs(case_when(. =="Not at all beneficial" ~ 1,
                                                     . =="Slightly beneficial" ~ 2,
                                                     . =="Moderately beneficial" ~ 3,
                                                     . =="Very beneficial" ~ 4,
                                                     . =="Extremely beneficial" ~ 5 ))) %>%

# replace nuclear acceptance likert scale with numbers
  mutate_at(vars(N_accept,N_reluctantlyaccept,N_reject), funs(case_when(. == "Strongly disagree" ~ 1, 
                                                                        . == "Somewhat disagree" ~ 2,
                                                                        . == "Neither agree nor disagree" ~3,
                                                                        . == "Somewhat agree" ~ 4,
                                                                        . == "Strongly agree" ~ 5))) %>%
  
  
# code likert scale for variables for Kahan scale into numbers
  mutate_at(vars(starts_with (c("K_S","K_E","DISPLACE", "POLLUTE", "HEALTH", "JOBS", "BEAUTY", "PRIDE", "NPRIDE","DEV","PROSPER", "RELY"))), funs(case_when(. == "Strongly disagree" ~ 1, 
               . == "Somewhat disagree" ~ 2,
               . == "Neither agree nor disagree" ~3,
               . == "Somewhat agree" ~ 4,
               . == "Strongly agree" ~ 5))) %>%
  
# reverse code for likert scale for variables for Kahan scale into numbers
  mutate_at(vars(starts_with (c("K_H","K_I"))), funs(case_when(. == "Strongly disagree" ~ 5, 
                                                               . == "Somewhat disagree" ~ 4,
                                                               . == "Neither agree nor disagree" ~3,
                                                               . == "Somewhat agree" ~ 2,
                                                               . == "Strongly agree" ~ 1))) %>%

# code eco-pol scale variables into numbers
mutate_at(vars(SYSTEMDEMO,SYSTEMRELIGION,SYSTEMTECHNO,SYSTEMTOTAL,WEALTHLIM,MECHANISATION,DECISIONDECEN,INDUSTRYSMALL,ECONOMYLOCAL,ENVOVERDEV,OWNERPUB, OWNERREG), funs(case_when(. == "Strongly disagree" ~ 1, 
                        . == "Somewhat disagree" ~ 2,
                        . == "Neither agree nor disagree" ~3,
                        . == "Somewhat agree" ~ 4,
                        . == "Strongly agree" ~ 5))) %>%

# NO reverse code eco-pol scale variables into numbers 
 mutate_at(vars(DECISIONCEN,INDUSTRYLARGE,ECONOMYGLOBAL,OWNERPVT,OWNERNOREG), funs(case_when(. == "Strongly disagree" ~ 1, 
                                                                                                         . == "Somewhat disagree" ~ 2,
                                                                                                         . == "Neither agree nor disagree" ~3,
                                                                                                         . == "Somewhat agree" ~ 4,
                                                                                                         . == "Strongly agree" ~ 5))) %>%
  mutate_all(~ifelse(. == "Rather not say/ Don't know", "Rather not say/Don't know", .))%>%
  mutate_all(~ifelse(. == "West bengal", "West Bengal", .))%>%
  mutate_all(~ifelse(. == "WEST BENGAL", "West Bengal", .))%>%
  mutate_all(~ifelse(. == "Up", "Uttar Pradesh", .))%>%
  mutate_all(~ifelse(. == "Tamilnadu", "Tamil Nadu", .))%>%
  mutate_all(~ifelse(. == "UP", "Uttar Pradesh", .))
  


```

## Can do something with accept, reject and reluctantly accept. 

```{r}

## Can do something with accept, reject and reluctantly accept. 

n_acceptreject<- codedmodule2 %>%
                dplyr::select("N_accept", "N_reluctantlyaccept", "N_reject")

summary(n_acceptreject)
```


```{r, echo=FALSE}


formice <- codedmodule2[, grep("State|age|urban_rural|gender|caste|religion|Solar|SOLAR|Nuclear|NUCLEAR|Coal|COAL|K_S|K_E|K_H|K_I|WEALTHLIM|MECHANISATION|DECISIONDECEN|INDUSTRYSMALL|ECONOMYLOCAL|ENVOVERDEV|OWNERPUB|OWNERREG|DECISIONCEN|INDUSTRYLARGE|ECONOMYGLOBAL|OWNERPVT|OWNERNOREG", names(codedmodule2))]%>%
        dplyr::select(-c("Language", "Risky_INDSolar", "Ben_INDSolar", "religiontext"))


#dplyr:: select(starts_with (c("State", "age", "urban_rural", "gender", "caste", "religion","Risky_Solar", "Risky_Nuclear", "Risky_Coal", "Ben_Solar","Ben_Nuclear","Ben_Coal","K_S","K_E","K_H","K_I", "DISPLACE", "POLLUTE", "HEALTH", "JOBS", "BEAUTY", "PRIDE", "NPRIDE","DEV", "PROSPER", "RELY", "WEALTHLIM", "MECHANISATION", "DECISIONDECEN", "INDUSTRYSMALL", "ECONOMYLOCAL", "ENVOVERDEV", "OWNERPUB", "OWNERREG", "DECISIONCEN","INDUSTRYLARGE","ECONOMYGLOBAL","OWNERPVT","OWNERNOREG" )))

library(dplyr)

formice <- formice %>%
  mutate(across(Risky_Solar:age, ~factor(.x, ordered = TRUE)))%>%
  mutate(across(urban_rural:religion, ~factor(.x, ordered = FALSE)))%>%
  mutate(across(State, ~factor(.x, ordered = FALSE)))

str(formice)
summary(formice)


```

## Mifa dor Kahan scale 
```{r, echo =FALSE}
library(mifa)
library(mice)
library(psych)

 #cov_vars = -c(State, Risky_Solar, Risky_Nuclear, Risky_Coal, Ben_Solar, Ben_Nuclear, Ben_Coal, DECISIONDECEN, DECISIONCEN, INDUSTRYSMALL, INDUSTRYLARGE, ECONOMYLOCAL, ECONOMYGLOBAL, ENVOVERDEV, OWNERPVT, OWNERPUB, OWNERREG, OWNERNOREG, WEALTHLIM, MECHANISATION, DISPLACESOLAR, POLLUTESOLAR, HEALTHSOLAR, JOBSSOLAR, BEAUTYSOLAR, PRIDESOLAR, NPRIDESOLAR, DEVSOLAR, PROSPERSOLAR, RELYSOLAR, DISPLACECOAL, POLLUTECOAL, HEALTHCOAL, JOBSCOAL, BEAUTYCOAL, PRIDECOAL, NPRIDECOAL, DEVCOAL, PROSPERCOAL, RELYCOAL, DISPLACENUCLEAR, POLLUTENUCLEAR, HEALTHNUCLEAR, JOBSNUCLEAR, BEAUTYNUCLEAR, PRIDENUCLEAR, NPRIDENUCLEAR, DEVNUCLEAR, PROSPERNUCLEAR, RELYNUCLEAR, age, urban_rural, gender, caste, religion),

kahanall <- codedmodule2 %>%
          dplyr::select(c(starts_with("K_")))

mikahan <- mifa(data= kahanall,
                cov_vars = everything(),
                n_pc= 2:4,
                ci = "fieller", 
                n_boot=1000,
                print = FALSE,
                progress= TRUE, 
                seed = 427,)




mikahan


library(psych)

fit <- psych::fa(mikahan$cov_combined, nfactors = 2, rotate = "varimax")

print.psych(fit, sort= TRUE, cut= 0.4)


data_imp <- mice::complete(mice::mice(kahanall, 1, print = FALSE))
  
fct_scores <- data.frame(factor.scores(data_imp[, 1:12], fit)$scores)


```


#checking imputations: Kahan scale

```{r}
orgscores <- data.frame(kahanefascores)


summary(mikahan)
names(mikahan)

mikahan$mids


complete_data_first <- complete(mikahan$mids, 1)

summary(complete_data_first)

complete_data_2 <- complete(mikahan$mids, 2)

summary(complete_data_2)

complete_data_3 <- complete(mikahan$mids, 3)

summary(complete_data_3)

complete_data_4 <- complete(mikahan$mids, 4)

summary(complete_data_4)

complete_data_5 <- complete(mikahan$mids, 5)

summary(complete_data_5)
```

 
## Distribution check: kahan Scale

```{r}
# Add an identifier column to each dataset
fct_scores$Dataset <- 'fct_scores'
orgscores$Dataset <- 'orgscores'

# Combine the datasets for plotting
combined_data <- rbind(fct_scores, orgscores)

# Select only necessary columns (assuming 'Index' isn't needed anymore)
combined_data <- combined_data[, c("MR1", "MR2", "Dataset")]


ggplot(combined_data, aes(x = Dataset, y = MR1, fill = Dataset)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, aes(color = Dataset), size = 1.5, alpha = 0.5) +
  labs(title = "Boxplot of MR1 for Each Dataset", x = "", y = "MR1 Value") +
  scale_fill_manual(values = c("fct_scores" = "blue", "orgscores" = "red")) +
  scale_color_manual(values = c("fct_scores" = "blue", "orgscores" = "red")) +
  theme_minimal()

```
```{r}
ggplot(combined_data, aes(x = Dataset, y = MR2, fill = Dataset)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, aes(color = Dataset), size = 1.5, alpha = 0.5) +
  labs(title = "Boxplot of MR2 for Each Dataset with Points", x = "", y = "MR2 Value") +
  scale_fill_manual(values = c("fct_scores" = "blue", "orgscores" = "red")) +
  scale_color_manual(values = c("fct_scores" = "blue", "orgscores" = "red")) +
  theme_minimal()

```


# Mifa for new eco-pol value scale : Nuclear energy

```{r}

ecopoln <- codedmodule2[, grep("NUCLEAR|WEALTHLIM|MECHANISATION|DECISIONDECEN|INDUSTRYSMALL|ECONOMYLOCAL|ENVOVERDEV|OWNERPUB|OWNERREG|DECISIONCEN|INDUSTRYLARGE|ECONOMYGLOBAL|OWNERPVT|OWNERNOREG", names(codedmodule2))]


miecopol <- mifa(data= ecopoln,
                cov_vars = everything(),
                n_pc= 2:4,
                ci = "fieller", 
                n_boot=1000,
                print = FALSE,
                progress= TRUE, 
                seed = 429,)

miecopol


fit2 <- psych::fa(miecopol$cov_combined, nfactors = 2, rotate = "varimax")

print.psych(fit2, sort= TRUE, cut= 0.4)


data_imp2 <- mice::complete(mice::mice(ecopoln, 1, print = FALSE))
  
fct_scores2 <- data.frame(factor.scores(data_imp2[, 1:23], fit2)$scores)

```

## Checking imputations : Eco-pol scale

```{r, echo=FALSE}

orgscores <- data.frame(kahanefascores)


summary(miecopol)
names(miecopol)

miecopol$mids


complete_ecopol_first <- complete(miecopol$mids, 1)

summary(complete_ecopol_first)

complete_ecopol_2 <- complete(miecopol$mids, 2)

summary(complete_ecopol_2)

complete_ecopol_3 <- complete(miecopol$mids, 3)

summary(complete_ecopol_3)

complete_ecopol_4 <- complete(miecopol$mids, 4)

summary(complete_ecopol_4)

complete_ecopol_5 <- complete(miecopol$mids, 5)

summary(complete_ecopol_5)
```

